"""Type definitions for repair_sql module."""
from __future__ import annotations

from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional

from ..exec_sql.types import ExecutionResult
from ..inspect_schema.types import ColumnMetadata, SchemaContext
from .config import RepairConfig


@dataclass
class ColumnProfile:
    """
    Semantic profile of a column for repair heuristics.
    
    Attributes:
        semantic_role: Type of data (enum, temporal, geo, measure, etc.)
        safe_for_enum_constraints: Whether to use sample_values as closed set
        safe_for_repair_mapping: Whether to use this column in repairs
        hints: Additional metadata for repair logic
    """
    semantic_role: str = "unknown"
    safe_for_enum_constraints: bool = False
    safe_for_repair_mapping: bool = False
    hints: Dict[str, Any] = field(default_factory=dict)


@dataclass
class RepairIssue:
    """
    Structured explanation of a detected problem in the SQL.
    
    Attributes:
        issue_type: Type of issue (e.g., "enum_value_mismatch", "missing_year_filter")
        column: Column name involved in the issue
        table: Table name involved in the issue
        value_used: The problematic value used in SQL
        suggested_values: Valid values that could replace value_used
        question_value: Value extracted from the question (e.g., year)
        details: Additional debugging information
    """
    issue_type: str
    column: Optional[str] = None
    table: Optional[str] = None
    value_used: Optional[str] = None
    suggested_values: List[str] = field(default_factory=list)
    question_value: Optional[Any] = None
    details: Dict[str, Any] = field(default_factory=dict)


@dataclass
class RepairPatch:
    """
    Represents a specific change to the SQL.
    
    Attributes:
        description: Human-readable description of the patch
        new_sql: The modified SQL after applying the patch
        issues_resolved: List of RepairIssue objects this patch addresses
        metadata: Additional info (rule name, mechanisms used, etc.)
    """
    description: str
    new_sql: str
    issues_resolved: List[RepairIssue] = field(default_factory=list)
    metadata: Dict[str, Any] = field(default_factory=dict)


@dataclass
class RepairSignals:
    """
    Numerical signals for the Strategic Control Module (SCM).
    
    Attributes:
        values: Dictionary of signal_name -> float_value
            Standard signals:
            - repair_applied: 1.0 if patch was applied, 0.0 otherwise
            - repair_success: 1.0 if repair improved results
            - repair_row_count_delta: Change in row count
            - repair_exec_latency_delta_ms: Change in execution time
            - repair_used_year_rule: 1.0 if year rule was applied
            - repair_used_enum_rule: 1.0 if enum rule was applied
            - repair_used_llm_mapping: 1.0 if LLM was used for mapping
    """
    values: Dict[str, float] = field(default_factory=dict)


@dataclass
class RepairInput:
    """
    All inputs needed by the repair_sql module.
    
    Attributes:
        question: Original natural language question
        original_sql: SQL generated by gen_sql
        expected_shape: Expected result shape from gen_sql
        schema_context: Schema metadata from inspect_schema
        gen_signals: Signals from gen_sql module
        exec_result: Result of executing original_sql
        exec_signals: Signals from exec_sql module
        engine: Database engine ("snowflake" or "bigquery")
        db_config: Database connection configuration
        config: RepairConfig with module parameters
    """
    question: str
    original_sql: str
    expected_shape: Dict[str, Any]
    schema_context: SchemaContext
    gen_signals: Dict[str, float]
    exec_result: ExecutionResult
    exec_signals: Dict[str, float]
    engine: str
    db_config: Dict[str, Any] = field(default_factory=dict)
    config: RepairConfig = field(default_factory=RepairConfig)


@dataclass
class RepairResult:
    """
    Complete output from the repair_sql module.
    
    Attributes:
        applied: Whether a patch was successfully applied
        original_sql: The original SQL before repair
        repaired_sql: The modified SQL (if repair was applied)
        original_exec_result: ExecutionResult from original SQL
        repaired_exec_result: ExecutionResult from repaired SQL (if applied)
        issues: List of all detected issues
        patch: The patch that was applied (if any)
        repair_signals: Signals for SCM
        debug_info: Additional debugging information
    """
    applied: bool
    original_sql: str
    repaired_sql: Optional[str]
    original_exec_result: ExecutionResult
    repaired_exec_result: Optional[ExecutionResult]
    issues: List[RepairIssue] = field(default_factory=list)
    patch: Optional[RepairPatch] = None
    repair_signals: Dict[str, float] = field(default_factory=dict)
    debug_info: Dict[str, Any] = field(default_factory=dict)
